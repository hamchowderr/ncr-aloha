# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

NCR Aloha Voice Ordering Integration - bridges voice AI systems (Pipecat) with NCR Aloha POS via BSP APIs. Enables voice-based food ordering via phone (Telnyx) or browser (Daily.co WebRTC).

## Commands

### Backend (TypeScript/Express)
```bash
npm install              # Install dependencies
npm run dev              # Development with hot reload (tsx watch)
npm run server           # Start server once
npm run build            # Compile to dist/
npm start                # Run compiled code
npm run test:api         # Test API endpoints
```

### Frontend (React/Vite)
```bash
cd web
npm install
npm run dev              # Dev server on :5173
npm run build            # Production build
npm run lint             # ESLint
```

### Voice Bot (Python/Pipecat)
```bash
cd pipecat
python -m venv venv && source venv/bin/activate  # or venv\Scripts\activate on Windows
pip install -r requirements.txt
pip install 'pipecat-ai[daily,openai,deepgram,cartesia,silero]' pipecat-ai-flows

python test_order.py              # Text-based testing (Windows compatible)
python server_telnyx_flows.py     # Telnyx VOIP server (port 8765)
python bot_flows.py <room_url>    # Daily.co WebRTC bot
```

### Docker
```bash
docker compose up -d --build              # Start all services
docker compose build pipecat && docker compose up -d pipecat  # Rebuild single service
docker logs ncr-pipecat -f                # View logs
```

### Run Full Stack Locally
```bash
# Terminal 1: Backend on :3000
npm run server

# Terminal 2: Frontend on :5173
cd web && npm run dev
```

## Architecture

### Three-Service Architecture
1. **Backend** (`src/`, port 3000): Express API handling orders, menu, call metrics
2. **Frontend** (`web/`, port 5173): React UI with voice chat button
3. **Voice Bot** (`pipecat/`, port 8765): Python Pipecat handling phone/browser calls

### Data Flow
```
Phone/Browser → Pipecat Bot → POST /orders → NCR Aloha API
                    ↓
         Deepgram STT → GPT-4o → Cartesia TTS
```

### Voice Conversation Flow (Pipecat Flows)
```
greeting → order_collection → order_confirmation → customer_info → completion
```

### Key Backend Files
- `src/server.ts` - Express endpoints (/menu, /orders, /calls)
- `src/auth/hmac.ts` - HMAC-SHA512 signing for NCR APIs
- `src/services/order-service.ts` - Order processing orchestration
- `src/services/menu-matcher.ts` - Fuzzy matching spoken items to menu

### Key Pipecat Files
- `pipecat/server_telnyx_flows.py` - Main Telnyx VOIP server with Flows state machine
- `pipecat/bot_flows.py` - Daily.co WebRTC bot (browser voice calls)
- `pipecat/order_client.py` - HTTP client to TypeScript backend

## API Patterns

### NCR Authentication
All NCR API requests require HMAC-SHA512 signed headers generated by `src/auth/hmac.ts`.

### VoiceOrder → NCR Order Conversion
```typescript
// Voice bot sends this:
{ orderType: "pickup", items: [{itemName: "wings", size: "2 pounds", modifiers: ["honey garlic"]}], customer: {name, phone} }

// Backend converts to NCR format via OrderBuilder
```

### Pipecat Flows API (Current Pattern)
```python
# FlowManager requires task and context_aggregator
context = OpenAILLMContext()
context_aggregator = llm.create_context_aggregator(context)
task = PipelineTask(pipeline, params=PipelineParams(...))
flow_manager = FlowManager(task=task, llm=llm, context_aggregator=context_aggregator)

# Handlers embedded in nodes via FlowsFunctionSchema
FlowsFunctionSchema(name="add_item", handler=async_handler, properties={...})
```

## Environment Variables

### Backend (.env)
```
NCR_API_GATEWAY, NCR_ORGANIZATION, NCR_SITE_ID, NCR_SHARED_KEY, NCR_SECRET_KEY
```

### Pipecat (pipecat/.env)
```
DAILY_API_KEY, TELNYX_API_KEY, DEEPGRAM_API_KEY, OPENAI_API_KEY, CARTESIA_API_KEY, CARTESIA_VOICE_ID
ORDER_API_URL=http://localhost:3000
PUBLIC_URL=https://your-domain.com  # Required for Telnyx
```

## Deployment

Production runs on VPS at `/var/www/ncr-aloha` with Docker Compose:
- Backend: `ncr-backend` container (port 3000)
- Pipecat: `ncr-pipecat` container (port 8765)
- Nginx reverse proxy routes `/api/` → backend, `/ws` → pipecat

Deploy with: `cd /var/www/ncr-aloha && git pull && docker compose build && docker compose up -d`
